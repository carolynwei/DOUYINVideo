# 更新日志 (Changelog)

本文档记录 ASSASSIN AI 项目的所有重要更新和变更。

## [v3.0.0] - 2026-02-22

### ✨ 新增功能

#### 渐进式工作流系统
- **对话微调**：用自然语言描述修改需求，AI智能调整剧本
  - 新增 `refine_script_by_chat()` 函数
  - 支持局部修改，保持其他内容不变
  - 智能理解用户意图（如"加点反转"、"缩短时长"）

- **版本管理**：自动保存历史版本，支持一键回滚
  - 新增 `script_versions` 和 `current_version_index` 状态管理
  - 每次锁定自动保存快照（时间戳 + scenes数据）
  - 顶部添加版本切换下拉框

- **状态机**：完整的工作流状态控制
  - draft → locked → producing → completed 流转
  - 根据状态动态显示/隐藏按钮
  - 防止误操作和状态混乱

#### BGM风格路由系统
- **自动匹配**：根据剧本风格自动选择BGM
  - 支持5种风格：认知刺客、听劝养成、POV沉浸、情绪宣泄、Meme抗象
  - 每种风格独立文件夹：`assets/bgm/{style}/`
  - 随机抽取，自动循环，风格化音量调整

- **多级容错**：完善的降级策略
  - 优先使用风格化BGM
  - 风格目录为空时回退到默认BGM
  - 支持旧版本路径兼容

#### TTS情绪标注系统
- **SSML支持**：语音合成标记语言集成
  - 语速控制：`<prosody rate="fast/slow">`
  - 音调控制：`<prosody pitch="+15%/-10%">`
  - 音量控制：`<prosody volume="+20%">`

- **自动标注**：AI生成剧本时自动添加情绪标签
  - 每个分镜至少标注1-2处情绪转折点
  - Hook（前3秒）必须有强烈的语速/音调变化
  - Edge TTS原生支持，无需额外处理

### 🎨 UI增强

#### 浅色模式完善
- 新增30项CSS规则，覆盖所有UI组件：
  - 全局背景、文字颜色、边框
  - 输入框、下拉框、按钮样式
  - 数据编辑器、表格样式
  - 消息框（Success/Error/Warning/Info）
  - 进度条、Toast提示、Spinner动画
  - 代码块、文件上传器、下载按钮
  - 侧边栏分割线和标题

### 🐛 问题修复

#### 浅色模式CSS不完整（两次修复）
- **第一次修复**：15项基础CSS规则
  - 修复全局背景色、文字颜色、表格内容等
- **第二次修复**：15项高级CSS规则
  - 修复下拉框、Primary按钮、进度条等

#### 中文乱码问题
- 所有Python文件添加UTF-8编码声明
- 将所有 `print()` 替换为 Streamlit 输出（`st.error/st.info/st.warning`）
- 修改文件：app.py, api_services.py, video_engine.py, db_manager.py, chat_page.py

#### OSError音频文件不存在
- 新增5层音频生成容错机制：
  1. 文件生成验证（检查存在和大小）
  2. 双重检查（None检查 + 文件存在检查）
  3. Try-Catch包裹（异常捕获）
  4. 全局失败检测（统计成功数量）
  5. 详细错误日志（显示当前处理的文本）

#### st.data_editor删除行不生效
- 实时同步 `edited_scenes` 到 `st.session_state`
- 修复删除/新增行的操作不生效问题

#### TypeError切片操作
- 新增三层防护：
  1. 空值检查：`if narration:`
  2. 类型检查：`isinstance(narration, str)`
  3. 长度检查：`if len(narration) > 50`

### ⚙️ 架构优化

#### 仓库结构整理
- **新增目录**：
  - `tests/` - 测试文件目录
  - `docs/` - 文档目录
  - `scripts/` - 脚本目录

- **资源文件移动**：
  - `font.ttf` → `assets/font.ttf`
  - `bgm.mp3` → `assets/bgm.mp3`
  - `改进.md` → `docs/改进.md`
  - `test_pipeline.py` → `tests/test_pipeline.py`
  - `test_zhipu_api.py` → `tests/test_zhipu_api.py`

#### 路径自动适配
- **video_engine.py** 更新文件路径：
  - 优先使用 `assets/font.ttf`
  - 优先使用 `assets/bgm.mp3`
  - 向后兼容旧版本路径

- **多级降级策略**：
  1. 优先：assets目录（绝对路径）
  2. 降级：assets目录（相对路径）
  3. 兼容：根目录（旧版本）
  4. 最终：系统字体（Linux）

#### .gitignore完善
- 新增数据库文件排除：`*.db`, `*.sqlite`, `*.sqlite3`
- 新增临时文件规则：`temp_*`, `*.tmp`
- 优化图片/音频规则，保留BGM资源库
- 新增日志文件排除：`*.log`, `logs/`
- 新增Jupyter Notebook排除：`*.ipynb`, `.ipynb_checkpoints/`

### 📚 文档更新

#### README.md 重构
- 更新标题为 "ASSASSIN AI - 认知刺客创作平台"
- 重写核心功能章节，突出渐进式工作流
- 新增详细的项目结构图（emoji标记）
- 更新使用指南，增加对话微调步骤
- 新增2个常见问题（BGM播放、对话微调）
- 更新文件路径说明（assets目录）

#### CHANGELOG.md 新增
- 完整记录v3.0.0版本的所有更新
- 详细的功能描述和技术细节
- 分类清晰：新增功能、UI增强、问题修复、架构优化

---

## [v2.0.0] - 2024-02

### ✨ 新增功能
- **对话创作模式**：全新的AI对话创作界面
- **聊天记录持久化**：SQLite数据库存储对话历史
- **用户积分系统**：新用户20积分，每日签到赠积分
- **多模型支持**：DeepSeek(1分) / GPT-4o(5分) / Claude 3.5(4分)
- **连续签到奖励**：最高15积分/天

### 🎨 UI增强
- 现代化聊天界面（st.chat_message）
- 侧边栏用户系统面板
- 积分余额实时显示

---

## [v1.5.0] - 2024-02

### ✨ 新增功能
- **火山引擎 TTS V3**：WebSocket流式传输，支持豆包大模型2.0
- **多音色支持**：京腔侃爷、俊朗男友、甜心小妹
- **AI二次精修**：毒舌总监风格的文案优化
- **画面提示词切换**：自动生成/手动编辑

### 🐛 问题修复
- 优化TTS合成速度
- 修复音频文件同步问题

---

## [v1.0.0] - 2024-01

### 🎉 首次发布
- **基础视频生成**：AI剧本 + TTS + 视频合成
- **热点挖掘**：抖音热搜榜单实时抓取
- **AI绘画**：智谱CogView-3-Plus高清分镜
- **BGM混音**：自动添加背景音乐
- **竖屏输出**：1080x1920标准短视频格式

---

## 版本规范说明

- **主版本号（Major）**：重大架构变更、不兼容的API修改
- **次版本号（Minor）**：新增功能、向后兼容的修改
- **修订号（Patch）**：问题修复、性能优化

### 提交规范
- `feat`: 新功能
- `fix`: 问题修复
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试相关
- `chore`: 构建/工具链更新
